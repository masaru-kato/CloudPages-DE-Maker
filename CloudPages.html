<script runat=server>

  Platform.Load('Core','1');
  
  var ret = 0;
  var msg = "";
  var postflg = Request.GetFormField('postflg');
  var postdata = Request.GetFormField('postdata1');
  var csv = Request.GetFormField('postdatacsv');
  
  if(postflg == 1){
    var name = Request.GetFormField("dename");
    var relcol = Request.GetFormField("relcolumn");
    var desc = Request.GetFormField("desc");;
    var cate = Request.GetFormField("category");;
    var fields = Platform.Function.ParseJSON(postdata);
    
    var deObj = {
      Name : name,
      CustomerKey : name,
      Description : desc,
      Fields : fields
    };
    
    if(cate !=null && cate != "" && cate != "0"){
      deObj.CategoryID=cate;
    }
    if(relcol != ""){
      deObj.SendableInfo = {
        Field : {
          Name : relcol,
          FieldType : "Text"
        },
        RelatesOn : "Subscriber Key"
      };
      deObj.IsTestable = "TRUE";
    }
      
    try{
      var de = DataExtension.Add(deObj); 
      msg = 'Success!'
      ret = 0;
    } catch(ex) {
      msg = "ERROR!!!!: " + Platform.Function.Stringify(ex);
      ret = 1;
    } 
    
  }else{
  }
  
  Variable.SetValue("jsonstr", Platform.Function.Stringify(deObj)); 
  Variable.SetValue("result", msg);
  Variable.SetValue("postflg", postflg);
  Variable.SetValue("ret", ret);  
  Variable.SetValue("csv", csv);
  Variable.SetValue("dename", name);
  Variable.SetValue("category", cate);
  </script>  
  <script runat="server">
  Platform.Load("core", "1");
  var api = new Script.Util.WSProxy();
  try {
    var req = api.retrieve("DataFolder", ["ID", "Name", "ParentFolder.ID"], {
              Property: "ContentType",
              SimpleOperator: "equals",
              Value: "dataextension"
    }); 
    var result = [];
    var results = req.Results;
    var strlist = "";
    for(var k in results) {
        result.push({id: results[k].ID, name:results[k].Name});
        strlist += "," + results[k].ID + "|" + results[k].Name + "|" + results[k].ParentFolder.ID;
    }
    Variable.SetValue("foldList", strlist.substring(1,9999));
  } catch(error) {
  } 
  </script>
  
  <!DOCTYPE html>
  <html lang="ja">
  <head>
      <meta charset="utf-8">
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet">
     <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
     <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" />      
  
  <style>
      #wrapper {
          display: -webkit-box;
          display: -moz-box;
          display: box;
      }
      #logs {
          list-style: none;
          padding: 0;
          margin: 0;
          width: 20%;
      }
      #logs li {
          margin: 0;
          padding: 0 0.5em;
          font-size: 80%;
          border-bottom: 1px solid #DDD;
      }
      .btn-flat-simple {
        position: relative;
        display: inline-block;
        font-weight: bold;
        padding: 0.25em 0.5em;
        text-decoration: none;
        color: #00BCD4;
        background: #ECECEC;
        transition: .4s;
      }
  
      .btn-flat-simple:hover {
        background: #00bcd4;
        color: white;
      }
    
  </style>
  
  </head>
  <body>
    <div class="container">
      <div>
        <h1 class="display-2">DE Maker
          <small class="text-muted">v0.34β</small>
        </h1>
        
        <div id="alert" class="alert alert-danger" role="alert">
          DE定義ERROR!!! Check Console.ERROR
        </div>
  %%[IF @postflg == 1 THEN]%%      
   %%[IF @ret == 1 THEN]%%
        <div id="alert" class="alert alert-danger" role="alert">
          %%=v(@result)=%%
        </div>
   %%[ELSE]%%
        <div class="alert alert-success" role="alert">
          %%=v(@result)=%%
        </div>      
   %%[ENDIF]%%
  %%[ENDIF]%%      

        <form id="postform" action="#">
            <p class="h4">
              DE Properties
            </p>          
            <div>
                <input type="hidden" id="postflg" name="postflg">
                <input type="hidden" id="postdata1" name="postdata1">
                <input type="hidden" id="postdatacsv" name="postdatacsv">
                <input type="hidden" id="relcolumn" name="relcolumn">
                <input type="hidden" id="cate" name="cate" value="%%=v(@category)=%%">
  
                <div class="row g-2 form-floating mb-3">
                  <div class="col-md">
                    <div class="form-floating">
                      <input type="Text" class="form-control" id="dename" name="dename" value="%%=v(@dename)=%%" placeholder="DataExtension Name Here" required>
                      <label for="name" class="form-label">DE Name</label>
                      </div>
                  </div>
                  <div class="col-md">
                    <div class="form-floating">
                      <select class="form-select" id="category" name="category" aria-label="select DE folder">
                        <option value="0" selected>select DE folder</option>
                      </select>
                      <label for="floatingSelectGrid">Folder Select</label>
                    </div>
                  </div>
                </div>              
                <div class="form-floating mb-3">
                    <input type="Text" class="form-control" id="desc" name="desc" value="%%=v(@desc)=%%" placeholder="Description Here">
                    <label for="name" class="form-label">Description</label>
                </div>
                <br>
              <!--
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="isSend">
                    <label class="form-check-label" for="isSend">Sendable</label>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="isTest">
                    <label class="form-check-label" for="isTest">For TEST</label>
                </div>
               -->
            </div>
        </form>  
      </div>
    
      <p class="h4">
        DE Fields
      </p>
      <div>
          <div id="grid"></div>
      </div>
      <div>
          <ol id="logs"></ol>
      </div>
  %%[IF @postflg == 1 THEN]%%
      <div>
        <a href="" class="btn btn-outline-primary m-5 btn-lg" id="btnRetry">  もう一回やる </a>
      </div>
      <div>
        <h1 class="display-6">--- DE OBJ JSON ---</h1>
        <p>%%=v(@jsonstr)=%%</p>
      </div>
  %%[ELSE]%%
    
      <div>
        <a href="#" class="btn btn-primary m-5 btn-lg" id="btnSubmit">  DE生成する!!  </a>
        <a href="" class="btn btn-outline-dark m-5 btn-lg" id="btnRetry">  もう一回やる  </a>
      </div>
  %%[ENDIF]%%
   </div>
  <script>
  $(function () {
      $("#alert").hide();
  
      var getData = function () {
  %%[IF @postflg == 1 THEN]%%
          return %%=v(@csv)=%%;
  %%[ELSE]%%
        let csv = [];
        for (let i = 0; i < 100; i++) {
          csv.push(["", "", "", false, false, "", false]);
        }
        return csv;
  
  %%[ENDIF]%%
      };
  
      var logs = $('#logs')
      gridContainer = document.getElementById('grid'),
          selectedRow = 0,
          selectedCol = 0,
          log = function (text) {
              // $('<li>').text(text).prependTo(logs);
          }
      gridTable = new Handsontable(gridContainer, {
          licenseKey: 'non-commercial-and-evaluation',
          data: getData(),
          width: function () {
              return 1300;
          },
          height: 500,
          colWidths: [300, 200, 200, 100, 100, 200, 100],
          /*            colWidths: function (index) {
                              },
                  */
          minSpareRows: 1,
          colHeaders: ['Field Name', 'Type', 'Length', 'PrimaryKey', 'Required', 'InitialValue', 'Relationship'],
          columns: [
              { "readOnly": false, "type": "text" },
              {
                  "readOnly": false,
                  type: 'autocomplete',
                  source: ['Text', 'Number', 'Date', 'EmailAddress', 'Boolean', 'Decimal','Phone'],
                  strict: true,
                  allowInvalid: false
              },
              { "readOnly": false, "type": "text", validator: /^[0-9,]*$/ },
              {
                  "readOnly": false,
                  "type": "checkbox",
                  source: [false, true],
                  strict: true,
                  allowInvalid: false
              },
              {
                  "readOnly": false,
                  "type": "checkbox",
                  source: [false, true],
                  strict: true,
                  allowInvalid: false
              },
              { "readOnly": false },
              { "type": "checkbox" }
          ],
          autoColumnSize: true,
          rowHeaders: true,
          contextMenu: true,
          cells: function (row, col, prop) {
              var cellProperties = {}
              return cellProperties;
          },
          afterChange: function (changes, source) {
          },
          afterSelection: function (r, c, r2, c2) {
          }
      });
  
      const buildOptionCate = function(arr, key, dep){
        let tmparr = arr.filter(e => e.parent === key);
        let spacing = "-";
        
        tmparr.sort(function (a, b) {
          return (a.name < b.name) ? -1 : 1;
        });
        
        for(let i=0;i<tmparr.length;i++){
          if($("#cate").val() == tmparr[i].id){
            $("#category").append(`<option value="${tmparr[i].id}" selected>${spacing.repeat(dep)}${tmparr[i].name}</option>`);
          }else{
            $("#category").append(`<option value="${tmparr[i].id}">${spacing.repeat(dep)}${tmparr[i].name}</option>`);
          }
          
          buildOptionCate(arr, tmparr[i].id, dep+1);
        }
        
      }
      //Category
      let catelist = "%%=v(@foldList)=%%";
      let arrCate = [];
      if(catelist){
        let cateobj = catelist.split(",");
        for(let i=0; i<cateobj.length;i++){
          let valtxt = cateobj[i].split("|");
          let tmp = {id:valtxt[0], name:valtxt[1], parent:valtxt[2]};
          arrCate.push(tmp);
        }
        buildOptionCate(arrCate, "0", 0)
      }

      // Submit
      $(document).on('click', '#btnSubmit', function (e) {
  
          var fields = gridTable.getData();
          var fieldsarry = [];
          var col = "";

          for (let i = 0; i < fields.length; i++) {
              var field = {
                  Name: "",
                  FieldType: "",
                  IsPrimaryKey: "",
                  IsRequired: ""
              };
  
              field.Name = fields[i][0];
              field.FieldType = fields[i][1];
              field.IsPrimaryKey = fields[i][3] || false;
              field.IsRequired = fields[i][4] || false;
  
              if (String(field.IsPrimaryKey).toUpperCase()=="TRUE"){
                field.IsPrimaryKey = true
                field.IsRequired = true;
              }
        
              if (field.Name == null || field.Name == "") {
                  break;
              }
  
              if (col == "" && (String(fields[i][6]).toUpperCase()=="TRUE")  ) {
                  col = field.Name;
              }
  
              if (fields[i][5] && fields[i][5].length > 0) {
                  field.DefaultValue = fields[i][5];
              }
  
              var isError = 0;
              switch (field.FieldType) {
                  case "Number":
                      break;
                  case "Decimal":
                      var dec = fields[i][2].split(",");;
                      field.Precision = dec[0];
                      field.Scale = dec[1];
                      break;
                  case "Text":
                      if(fields[i][2].length > 0){
                       field.MaxLength = fields[i][2];
                      }
                      break;
                  case "Boolean":
                      break;
                  case "Date":
                      field.Ordinal = 2;
                      break;
                  case "EmailAddress":
                      break;
                  case "Phone":
                      break;
                  default:
                      isError = 1;
                      console.error(`${i+1}行目 Data:${JSON.stringify(fields[i])}`);;
                      break;
              }
              fieldsarry.push(field);
  
              if (isError == 1) {
                  $("#alert").show();
                  return false;
              }
          }
  
          $('#postdata1').val(JSON.stringify(fieldsarry));
          $('#postdatacsv').val(JSON.stringify(fields));
          $('#postflg').val(1);
          $('#relcolumn').val(col);
  
          var target = document.getElementById("postform");
          //target.action = location.origin;
          target.method = "post";
          target.submit();
  
      });
  });
  </script>
  
  </body>
  </html>